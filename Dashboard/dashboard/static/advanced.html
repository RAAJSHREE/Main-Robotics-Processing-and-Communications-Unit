<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Advanced Robot Dashboard</title>
  <style>
    body { background: #05070a; color: white; font-family: Arial, sans-serif; padding: 20px; }
    h1 { text-align: center; color: #7ef7ff; }
    .container { max-width: 1100px; margin: auto; background: rgba(255,255,255,0.03); padding: 18px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); }
    .grid { display:grid; grid-template-columns: 1fr 360px; gap:16px; align-items:start; }
    .card { background: rgba(255,255,255,0.03); padding:12px; border-radius:10px; }
    .section-title { font-weight:600; margin-bottom:8px; color:#cfeffd; }
    canvas { background:transparent; border-radius:8px; width:100%; }
    .small { font-size:12px; color:#eef0f3; }
    .row { display:flex; gap:12px; }
    .col-3 { display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; }

    /* * NEW STYLES: Circular Progress Bar and Alignment 
     */
    .interface-metrics { 
        display: flex; 
        justify-content: space-around; 
        margin-top: 5px; 
        margin-bottom: 10px; /* Space between bars and chart */
        padding: 5px 0;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .metric-group { 
        text-align: center; 
        font-size: 10px; 
        margin: 0 5px; 
        flex: 1; /* Distribute space evenly */
    }
    .progress-circle { 
        width: 45px; /* Slightly smaller to fit better */
        height: 45px; 
        border-radius: 50%; 
        /* The conic-gradient creates the progress fill */
        background: radial-gradient(closest-side, #05070a 79%, transparent 80% 100%), conic-gradient(#56ccf2 0deg, #56ccf2 0deg, #384252 0deg);
        display: inline-grid;
        place-items: center;
        margin-bottom: 3px;
    }
    .progress-circle::before {
        content: attr(data-label);
        font-size: 11px;
        font-weight: bold;
        color: white;
    }
    .status-disk { 
        font-size: 16px; 
        font-weight: bold; 
        color: #7ef7ff; 
        line-height: 45px; /* Aligns text vertically */
        height: 45px;
        display: block;
    }
    .disk-low { 
        color: #ff5b5b !important; /* Low disk space alert color */
    }

    /* üí° Notification List Styles */
    #notificationList div {
        margin-bottom: 5px;
        padding: 5px;
        border-left: 3px solid #ff5b5b; /* Default alert color */
        background: rgba(255, 91, 91, 0.1);
        font-size: 11px;
        color: #fcebeb;
    }
    #notificationList .info {
        border-left: 3px solid #00d1b2;
        background: rgba(0, 209, 178, 0.1);
    }
  </style>
</head>
<body>
  <h1>Advanced Robot Dashboard</h1>
  
  <div class="container">
    <div class="grid">

            <div>
        <div class="card">
          <div class="section-title">Live Robot Map & Status</div>
          <canvas id="mapCanvas" width="900" height="300" style="height:300px;"></canvas>
          <div class="row" style="margin-top:10px;">
            <div style="flex:1;" class="small">
              **System State:** <span id="adv_system_state">INITIALIZING</span><br>
              **E-STOP:** <span id="adv_estop">--</span><br>
              **P2 Driver:** <span id="p2_status">--</span><br>
              **P3 Driver:** <span id="p3_status">--</span><br>
              **P4 Driver:** <span id="p4_status">--</span>
            </div>
            <div style="width:220px;text-align:right;" class="small">
              **Last Update:** <span id="adv_last_update">--</span><br>
              <span id="adv_connectivity">OFFLINE</span>
            </div>
            </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <div class="section-title">System Activity Log</div>
          <div id="systemActivityLog" style="height:220px;overflow-y:auto;font-size:11px;" class="small"></div>
        </div>

        <div class="row" style="margin-top:12px;">
          <div class="card" style="flex:1;">
            <div class="section-title">Timeline Events</div>
            <canvas id="timelineChart" width="400" height="140"></canvas>
            <div class="small" id="tlText"></div>
          </div>

          <div class="card" style="width:340px;">
            <div class="section-title">Heartbeat Signal</div>
            <canvas id="heartbeatChart" width="320" height="140"></canvas>
            <div class="small" id="hbText">Last: --</div>
          </div>
        </div>
      </div>

            <div>
        <div class="card">
          <div class="section-title">Quick Controls</div>
          <div class="row">
            <button onclick="sendCmd({action:'move', direction:'forward'})">‚¨Ü Forward</button>
            <button onclick="sendCmd({action:'move', direction:'left'})">‚¨Ö Left</button>
            <button onclick="sendCmd({action:'move', direction:'right'})">‚û° Right</button>
          </div>
          <div style="margin-top:8px;" class="row">
            <button onclick="sendCmd({action:'move', direction:'back'})">‚¨á Back</button>
            <button onclick="sendCmd({action:'stop'})">‚èπ Stop</button>
            <button onclick="sendCmd({type:'safety', action:'E_STOP'})" style="background:#ff5b5b">üõë E-STOP</button>
          </div>
        </div>

                <div class="card" style="margin-top:12px; height:180px; overflow:auto;">
          <div class="section-title">üö® Critical Notifications (Last 5)</div>
          <div id="notificationList" class="small">No alerts.</div>
        </div>

        <div class="card" style="margin-top:12px; height:200px; overflow:auto;">
          <div class="section-title">Logs</div>
          <div id="logList" class="small"></div>
        </div>


                <div class="card" style="margin-top:12px;">
          <div class="section-title">P2 Driver (Cameras/LiDAR)</div>
          <div class="small" style="padding:10px;">
            Status: <span id="p2_driver_status">--</span><br>
            Last Heartbeat: <span id="p2_last_hb">--</span>
          </div>
          <canvas id="p2Chart" width="320" height="160"></canvas>
        </div>

                <div class="card" style="margin-top:12px;">
          <div class="section-title">P3 Driver (Motors)</div>
          <div class="small" style="padding:10px;">
            Status: <span id="p3_driver_status">--</span><br>
            Last Heartbeat: <span id="p3_last_hb">--</span>
          </div>
          <canvas id="p3Chart" width="320" height="160"></canvas>
        </div>

                <div class="card" style="margin-top:12px;">
          <div class="section-title">P4 Driver (LEDs/Gripper)</div>
          <div class="small" style="padding:10px;">
            Status: <span id="p4_driver_status">--</span><br>
            Last Heartbeat: <span id="p4_last_hb">--</span>
          </div>
          <canvas id="p4Chart" width="320" height="160"></canvas>
        </div>

      </div>
    </div>
  </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', (event) => {
        
        // --- Core Helpers ---
        const MAX_POINTS = 60;
        const DISK_ALERT_THRESHOLD = 20; // Alert if disk space is 20% or lower
        const CPU_MEMORY_ALERT_THRESHOLD = 90; // Alert if main CPU/Memory usage exceeds 90%
        
        function pushTrim(arr, v){ arr.push(v); if(arr.length>MAX_POINTS) arr.shift(); }

        function appendToLog(s){
          const el = document.getElementById('logList');
          const t = new Date().toLocaleTimeString();
          if(el) el.innerHTML = `<div>[${t}] ${s}</div>` + el.innerHTML;
        }

        // --- Ping Sound Generator (Inbuilt) ---
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        function playPingSound() {
            if (!audioContext) return;
            // üö® IMPORTANT: Do not play ping sound for E-STOP or cleared E-STOP
            // Only play for connectivity/performance degradation alerts.
            if(document.getElementById('adv_estop').innerText === 'üõë ACTIVE') return; 

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            const now = audioContext.currentTime;

            oscillator.type = 'sine'; 
            oscillator.frequency.setValueAtTime(800, now); 
            
            gainNode.gain.setValueAtTime(0, now);
            gainNode.gain.linearRampToValueAtTime(0.5, now + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.3);

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.start(now);
            oscillator.stop(now + 0.3); 
        }

        // üí° Notification State and Helper
        const notifications = [];
        const MAX_NOTIFICATIONS = 5;

        function addNotification(message, level='CRITICAL') {
            const now = new Date().toLocaleTimeString();
            const colorClass = level === 'INFO' ? 'info' : '';
            const messageHtml = `<div class="${colorClass}">[${now}] **${level}**: ${message}</div>`;
            
            notifications.unshift(messageHtml);
            
            // Keep only the last 5
            while (notifications.length > MAX_NOTIFICATIONS) {
                notifications.pop();
            }

            const listEl = document.getElementById('notificationList');
            if (listEl) {
                listEl.innerHTML = notifications.join('');
            }
        }

        // üí° NEW FUNCTION: Circular Progress Bar Update
        function updateCircleProgress(elementId, value) {
            const el = document.getElementById(elementId);
            if (el) {
                const percent = Math.min(100, Math.max(0, value)); 
                
                let color = '#56ccf2'; // Default blue
                // Change color if high CPU/MEM usage (e.g., above 85%)
                if (percent > 85) {
                    color = '#ff5b5b'; // Red for alert
                }

                // Update the CSS conic-gradient property for the circular fill
                el.style.background = `radial-gradient(closest-side, #05070a 79%, transparent 80% 100%), conic-gradient(${color} ${percent}%, #384252 ${percent}%)`;
                
                // Update the text label
                el.setAttribute('data-label', `${Math.round(percent)}%`);
            }
        }

        // --- Global State ---
        let lastHeartbeatTime = Date.now();
        const HEARTBEAT_EXPECTED_S = 5; 
        let lastPos = null, lastTs = null;
        let trace = [];
        let timelineBuckets = [];

        // Track active alerts to avoid spamming notifications/sound
        const activeDiskAlerts = { p2: false, p3: false, p4: false };
        // Now tracks a combined CPU/Memory alert state
        const activeAlerts = { cpu_mem: false }; // Removed 'heartbeat' since we removed latency alert


        // --- Chart Initialization ---

        // Timeline Chart 
        const timelineChart = new Chart(document.getElementById('timelineChart').getContext('2d'), {
          type:'bar', data:{ labels:[], datasets:[{ label:'events', data:[], backgroundColor:'#8be5ff' }]}, options:{ animation:false, scales:{ x:{ display:false } } }
        });

        // Heartbeat Chart 
        const heartbeatChart = new Chart(document.getElementById('heartbeatChart').getContext('2d'), {
          type:'line', 
          data:{ 
            labels:[], 
            datasets:[{ 
              // ‚ö†Ô∏è CHANGED LABEL
              label:'Raw Heartbeat Signal', 
              data:[], 
              borderColor:'#ef4444', 
              tension:0.2, 
              pointRadius:0 
            }]
          }, 
          options:{ 
            animation:false, 
            scales:{ 
              x:{ display:false }, 
              y: { 
                // Removed min/max bounds so chart auto-scales to the raw beat counter
                title: { display: true, text: 'Raw Beat Value' } 
              } 
            } 
          }
        });

        // Single Protocol Chart Factory
        function createSingleProtocolChart(canvasId, protocolName, color) {
            return new Chart(document.getElementById(canvasId).getContext('2d'), {
                type: 'line',
                data: { 
                    labels: [], 
                    datasets: [{ 
                        label: protocolName, 
                        data: [], 
                        borderColor: color, 
                        tension: 0.2, 
                        pointRadius: 0 
                    }]
                },
                options: { 
                    animation: false, 
                    scales: { x: { display: false } },
                    plugins: { legend: { display: false } }
                }
            });
        }
        
        // Assign specific protocols and colors:
        const p2Chart = createSingleProtocolChart('p2Chart', 'CANOpen', '#7dd3fc'); 
        const p3Chart = createSingleProtocolChart('p3Chart', 'Ethernet', '#60a5fa'); 
        const p4Chart = createSingleProtocolChart('p4Chart', 'Optical', '#f97316'); 


        // --- Map Drawing Logic (unchanged) ---
        const mapCanvas = document.getElementById('mapCanvas');
        const mctx = mapCanvas.getContext('2d');
        function drawMap(){
            const w = mapCanvas.width, h = mapCanvas.height;
            mctx.clearRect(0,0,w,h);
            mctx.fillStyle = '#021017'; mctx.fillRect(0,0,w,h);
            mctx.strokeStyle = 'rgba(255,255,255,0.03)'; mctx.lineWidth=1;
            for(let x=0;x<w;x+=30){ mctx.beginPath(); mctx.moveTo(x,0); mctx.lineTo(x,h); mctx.stroke(); }
            for(let y=0;y<h;y+=30){ mctx.beginPath(); mctx.moveTo(0,y); mctx.lineTo(w,y); mctx.stroke(); }

            if(trace.length){
              mctx.beginPath();
              for(let i=0;i<trace.length;i++){
                const p = trace[i];
                const cx = w/2 + p.x*10;
                const cy = h/2 - p.y*10;
                if(i===0) mctx.moveTo(cx,cy); else mctx.lineTo(cx,cy);
              }
              mctx.strokeStyle = '#56ccf2';
              mctx.lineWidth = 2;
              mctx.stroke();

              const last = trace[trace.length-1];
              const rx = w/2 + last.x*10;
              const ry = h/2 - last.y*10;
              mctx.beginPath();
              mctx.arc(rx,ry,8,0,Math.PI*2);
              mctx.fillStyle = last.led ? '#ffd166' : '#56ccf2';
              mctx.fill();
            }
        }

        // --- Command Sender (unchanged) ---
        function sendCmd(cmd) {
            cmd.robot_id = "robot-alpha"; 
            fetch('/api/command', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(cmd)
            }).then(response => {
                if (!response.ok) {
                    console.error("Command failed", response);
                }
            });
        }

        // --- WebSocket Connection ---
        const proto = location.protocol === 'https:' ? 'wss' : 'ws';
        const ws = new WebSocket(proto + '://' + location.host + '/ws/telemetry');

        ws.onopen = ()=> appendToLog('WS connected');
        ws.onclose = ()=> appendToLog('WS closed');

        ws.onmessage = (ev) => {
          let data;
          try{ data = JSON.parse(ev.data); } catch(e){ data = { raw: ev.data }; }
          const payload = data.type ? data : (data.payload ? data.payload : data);
          const nowLabel = new Date().toLocaleTimeString();
          
          const estopEl = document.getElementById('adv_estop');
          const connEl = document.getElementById('adv_connectivity');
          const soundEl = document.getElementById('adv_sound');
          
          // --- Alerts and Status Updates ---
          
          // Watchdog Offline - PING HERE
          if(payload.type === 'watchdog'){
              if (payload.status === 'OFFLINE' && connEl) {
                  connEl.innerText = 'üö® OFFLINE';
                  connEl.style.color = '#ff5b5b'; 
                  playPingSound(); 
                  addNotification('Watchdog connection lost.', 'CRITICAL'); 
                  appendToLog(`üö® CRITICAL WATCHDOG: ${payload.message}`);
                  const sysStateEl = document.getElementById('adv_system_state');
                  if(sysStateEl) { sysStateEl.innerText = 'OFFLINE'; sysStateEl.style.color = '#ff5b5b'; }
              }
          }

          // Connectivity/E-STOP from Heartbeat
          if(payload.type === 'heartbeat' || payload.type === 'telemetry'){
              if(connEl && payload.type !== 'watchdog') {
                  connEl.innerText = '‚úÖ ONLINE';
                  connEl.style.color = 'limegreen';
              }
              const lastUpdateEl = document.getElementById('adv_last_update');
              if(lastUpdateEl) lastUpdateEl.innerText = nowLabel;
          } 
          
          if(payload.type === 'heartbeat'){
            const status = payload.status || 'OK';
            const nodeName = payload.node_name || '';
            const rawBeat = parseFloat(payload.raw_beat) ?? 0;
            const now = Date.now();
            const latency_s = (now - lastHeartbeatTime) / 1000; 
            lastHeartbeatTime = now;
            
            // Update driver status based on node_name
            if(nodeName.includes('p2')){
              const el = document.getElementById('p2_status');
              const hbEl = document.getElementById('p2_last_hb');
              const statusEl = document.getElementById('p2_driver_status');
              if(el) { el.innerText = status === 'E_STOP' ? 'üõë E-STOP' : '‚úÖ OK'; el.style.color = status === 'E_STOP' ? '#ff5b5b' : 'limegreen'; }
              if(hbEl) hbEl.innerText = nowLabel;
              if(statusEl) { statusEl.innerText = status === 'E_STOP' ? 'üõë E-STOP' : '‚úÖ OK'; statusEl.style.color = status === 'E_STOP' ? '#ff5b5b' : 'limegreen'; }
            } else if(nodeName.includes('p3')){
              const el = document.getElementById('p3_status');
              const hbEl = document.getElementById('p3_last_hb');
              const statusEl = document.getElementById('p3_driver_status');
              if(el) { el.innerText = status === 'E_STOP' ? 'üõë E-STOP' : '‚úÖ OK'; el.style.color = status === 'E_STOP' ? '#ff5b5b' : 'limegreen'; }
              if(hbEl) hbEl.innerText = nowLabel;
              if(statusEl) { statusEl.innerText = status === 'E_STOP' ? 'üõë E-STOP' : '‚úÖ OK'; statusEl.style.color = status === 'E_STOP' ? '#ff5b5b' : 'limegreen'; }
            } else if(nodeName.includes('p4')){
              const el = document.getElementById('p4_status');
              const hbEl = document.getElementById('p4_last_hb');
              const statusEl = document.getElementById('p4_driver_status');
              if(el) { el.innerText = status === 'E_STOP' ? 'üõë E-STOP' : '‚úÖ OK'; el.style.color = status === 'E_STOP' ? '#ff5b5b' : 'limegreen'; }
              if(hbEl) hbEl.innerText = nowLabel;
              if(statusEl) { statusEl.innerText = status === 'E_STOP' ? 'üõë E-STOP' : '‚úÖ OK'; statusEl.style.color = status === 'E_STOP' ? '#ff5b5b' : 'limegreen'; }
            }
            
            // --- E-STOP Logic (Notification only, NO PING) ---
            if(estopEl){
              if(status === 'E_STOP'){
                  if(estopEl.innerText !== 'üõë ACTIVE') {
                      addNotification('Emergency STOP activated!', 'CRITICAL'); 
                  }
                  estopEl.innerText = 'üõë ACTIVE';
                  estopEl.style.color = '#ff5b5b';
                  const sysStateEl = document.getElementById('adv_system_state');
                  if(sysStateEl) { sysStateEl.innerText = 'E-STOP ACTIVE'; sysStateEl.style.color = '#ff5b5b'; }
              } else {
                  if(estopEl.innerText === 'üõë ACTIVE'){
                    addNotification('E-STOP cleared.', 'INFO'); 
                  }
                  estopEl.innerText = '‚úÖ CLEAR';
                  estopEl.style.color = 'limegreen';
                  const sysStateEl = document.getElementById('adv_system_state');
                  if(sysStateEl) { sysStateEl.innerText = 'OPERATIONAL'; sysStateEl.style.color = 'limegreen'; }
              }
            }
            
            // Update heartbeat chart
            pushTrim(heartbeatChart.data.labels, nowLabel);
            pushTrim(heartbeatChart.data.datasets[0].data, rawBeat);
            heartbeatChart.update();
            
            const hbTextEl = document.getElementById('hbText');
            if(hbTextEl) hbTextEl.innerText = `Last: ${nowLabel} (${nodeName})`;
            
            appendToLog(`Heartbeat from ${nodeName}: ${status}`);
          }

          // Log messages
          if(payload.type === 'log'){
            const activityLog = document.getElementById('systemActivityLog');
            if(activityLog){
              const logEntry = `<div>[${nowLabel}] ${payload.level || 'INFO'}: ${payload.message || JSON.stringify(payload)}</div>`;
              activityLog.innerHTML = logEntry + activityLog.innerHTML;
            }
          }
          
          
          // --- Map Updates (if position data exists) ---
          const pos = payload.position ?? null;
          if(pos && typeof pos.x === 'number'){
            trace.push({ x: pos.x, y: pos.y, led: false }); 
            if(trace.length>300) trace.shift();
            drawMap();
            lastPos = pos; lastTs = Date.now();
          }
          
          // Timeline chart updates
          const evType = payload.type ?? 'unknown';
          timelineBuckets.push({ t: nowLabel, type: evType }); if(timelineBuckets.length>MAX_POINTS) timelineBuckets.shift();
          const labels = timelineBuckets.map(b=>b.t);
          const counts = timelineBuckets.map((_,i)=> timelineBuckets.slice(Math.max(0,i-5),i+1).length);
          timelineChart.data.labels = labels;
          timelineChart.data.datasets[0].data = counts;
          timelineChart.update();
          
          
          // --- Driver Heartbeat Charts (count heartbeats over time) ---
          if(payload.type === 'heartbeat' && payload.node_name){
            const nodeName = payload.node_name;
            const now = nowLabel;
            
            if(nodeName.includes('p2')){
              pushTrim(p2Chart.data.labels, now);
              pushTrim(p2Chart.data.datasets[0].data, 1);
              while(p2Chart.data.labels.length > MAX_POINTS) p2Chart.data.labels.shift();
              while(p2Chart.data.datasets[0].data.length > MAX_POINTS) p2Chart.data.datasets[0].data.shift();
              p2Chart.update();
            } else if(nodeName.includes('p3')){
              pushTrim(p3Chart.data.labels, now);
              pushTrim(p3Chart.data.datasets[0].data, 1);
              while(p3Chart.data.labels.length > MAX_POINTS) p3Chart.data.labels.shift();
              while(p3Chart.data.datasets[0].data.length > MAX_POINTS) p3Chart.data.datasets[0].data.shift();
              p3Chart.update();
            } else if(nodeName.includes('p4')){
              pushTrim(p4Chart.data.labels, now);
              pushTrim(p4Chart.data.datasets[0].data, 1);
              while(p4Chart.data.labels.length > MAX_POINTS) p4Chart.data.labels.shift();
              while(p4Chart.data.datasets[0].data.length > MAX_POINTS) p4Chart.data.datasets[0].data.shift();
              p4Chart.update();
            }
          }
          
          // log only non-frequent event types
          if (payload.type !== 'telemetry' && payload.type !== 'heartbeat' && payload.type !== 'watchdog') {
              appendToLog(JSON.stringify({ t: nowLabel, type: payload.type ?? 'telemetry' }));
          }
        };
        
    }); // End of DOMContentLoaded
  </script>
</body>
</html>