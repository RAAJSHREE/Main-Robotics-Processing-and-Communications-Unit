<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ü§ñ AI-nonymous Dashboard</title>
    <style>
        body {
            font-family: "Segoe UI", Arial, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #dfe9f3, #ffffff);
            margin: 0;
        }

        /* --- TOP NAV BAR --- */
        .top-nav {
            width: 100%;
            padding: 15px 25px;
            background: rgba(255,255,255,0.6);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 0 0 14px 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .nav-title { font-size: 22px; font-weight: 700; color: #222; }

        .nav-button {
            background: linear-gradient(135deg, #3b82f6, #06b6d4);
            padding: 10px 18px; color: white; border-radius: 10px; font-size: 15px; font-weight: 600;
            text-decoration: none; box-shadow: 0 0 10px rgba(0,200,255,0.4); transition: 0.2s ease;
        }
        .nav-button:hover { transform: scale(1.05); box-shadow: 0 0 16px rgba(0,200,255,0.7); }

        h1 { color: #222; text-align: center; font-size: 32px; margin-bottom: 25px; margin-top: 15px; letter-spacing: 1px; }

        .container { max-width: 950px; margin: 0 auto; }

        .card { background: #fff; padding: 20px; margin-bottom: 22px; border-radius: 14px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); transition: 0.25s ease; }
        .card:hover { box-shadow: 0 6px 22px rgba(0,0,0,0.12); transform: translateY(-2px); }

        .robot-info p { margin: 6px 0; font-size: 16px; }
        .robot-info span { font-weight: bold; color: #222; }

        /* üí° NEW: E-STOP Status Classes for Visual Feedback */
        .status-estop-active { color: #ff3b3b; font-weight: bold; }
        .status-estop-clear { color: #16a34a; font-weight: bold; }

        button { margin: 6px; padding: 12px 18px; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 600; transition: 0.2s ease; }
        button:hover { opacity: 0.85; transform: scale(1.03); } button:active { transform: scale(0.98); }

        .estop { background: #ff3b3b; color: #fff; } .clear-estop { background: #16a34a; color: #fff; }
        .motion-btn { background: #3b82f6; color: #fff; } .stop-btn { background: #eab308; color: #000; }
        .led-on { background: #22c55e; color: #fff; } .led-off { background: #6b7280; color: #fff; }

        pre { max-height: 350px; overflow-y: auto; background: #111; color: #00ff9d; padding: 15px; border-radius: 8px; font-size: 14px; line-height: 1.4; }

        .section-title { font-size: 20px; margin-bottom: 12px; font-weight: 600; color: #303030; }

        /* Small interface/status cards */
        .iface-row { display:flex; gap:8px; margin-top:12px; }
        .iface { flex:1; background: #f7fafc; border-radius:8px; padding:8px; text-align:center; }
        .iface strong { display:block; font-size:18px; color:#111; }
        .heartbeat { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:12px; background:#111827; color:#fff; }
        .small-note { font-size:12px; color:#555; margin-top:6px; }
    </style>
</head>

<body>

<div class="top-nav">
    <div class="nav-title">ü§ñ AI-nonymous Control Dashboard</div>
    <a href="/advanced" class="nav-button">üìä Advanced Graphs</a>
</div>

<div class="container">
    <h1>Robot Dashboard</h1>

    <div class="card robot-info">
        <div class="section-title">System Status</div>
        <p><strong>Robot ID:</strong> <span id="robot-id">robot-alpha</span></p>
        <p><strong>System State:</strong> <span id="system-state">OPERATIONAL</span></p>
        <p><strong>E-STOP:</strong> <span id="estop-status" class="status-estop-clear">CLEAR</span></p>
        <p><strong>Last Update:</strong> <span id="last-update">--</span></p>

        <div class="section-title" style="margin-top:20px;">Hardware Drivers</div>
        <div class="iface-row">
            <div class="iface">
                <div class="small-note">P2 Camera/LiDAR</div>
                <strong id="p2_status">READY</strong>
            </div>
            <div class="iface">
                <div class="small-note">P3 Motors</div>
                <strong id="p3_status">READY</strong>
            </div>
            <div class="iface">
                <div class="small-note">P4 Actuators</div>
                <strong id="p4_status">READY</strong>
            </div>
        </div>

        <div style="margin-top:15px;">
            <span class="heartbeat" id="heartbeat_indicator">‚è± Waiting for heartbeat...</span>
        </div>
    </div>

    <div class="card controls">
        <div class="section-title">Controls</div>

        <button class="estop" onclick="sendEStop()">üõë E-STOP</button>
        <button class="clear-estop" onclick="sendClear()">‚úî Clear E-STOP</button>
        <br><br>

        <button class="motion-btn" onclick="sendMove('forward')">‚¨Ü Forward</button>
        <button class="motion-btn" onclick="sendMove('left')">‚¨Ö Left</button>
        <button class="motion-btn" onclick="sendMove('right')">‚û° Right</button>
        <button class="motion-btn" onclick="sendMove('back')">‚¨á Back</button>
        <button class="stop-btn" onclick="sendStop()">‚õî STOP</button>
        <br><br>

        <button class="led-on" onclick="sendLED('on')">üí° LED ON</button>
        <button class="led-off" onclick="sendLED('off')">LED OFF</button>
    </div>

    <div class="card logs">
        <div class="section-title">Logs / Telemetry</div>
        <pre id="logs"></pre>
    </div>

</div>
<script>
const robotId = document.getElementById("robot-id").innerText;
const logsEl = document.getElementById("logs");
const estopStatusEl = document.getElementById("estop-status");

// üëâ backend host (FastAPI) is on port 8000
const backendHost = window.location.hostname + ":8000";
const apiBase = window.location.protocol + "//" + backendHost;

function appendLog(msg) {
    logsEl.textContent += msg + "\n";
    logsEl.scrollTop = logsEl.scrollHeight;
}

function updateEStopDisplay(isActive) {
    if (isActive) {
        estopStatusEl.innerText = "ACTIVE";
        estopStatusEl.className = "status-estop-active";
    } else {
        estopStatusEl.innerText = "CLEAR";
        estopStatusEl.className = "status-estop-clear";
    }
}

async function sendCommand(payload) {
    payload.robot_id = robotId;
    try {
        await fetch(`${apiBase}/api/command`, {   // üëà was "/api/command"
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        if (payload.action === "E_STOP") {
            updateEStopDisplay(true);
        } else if (payload.action === "CLEAR_ESTOP") {
            updateEStopDisplay(false);
        }
    } catch (err) {
        console.error("Failed to send command:", err);
        appendLog("‚ö†Ô∏è Failed to send command: " + err);
    }
}

function sendEStop() { sendCommand({ type: "safety", action: "E_STOP" }); }
function sendClear() { sendCommand({ type: "safety", action: "CLEAR_ESTOP" }); }
function sendMove(direction) { sendCommand({ action: "move", direction: direction }); }
function sendStop() { sendCommand({ action: "stop" }); }
function sendLED(state) { sendCommand({ action: `led/${state}` }); }

// --------------- WebSocket ----------------
let wsProtocol = location.protocol === "https:" ? "wss" : "ws";
// üëá connect to backend:8000 instead of location.host (8080)
let ws = new WebSocket(`${wsProtocol}://${backendHost}/ws/telemetry`);

ws.onopen = () => appendLog("üü¢ WebSocket connected");
ws.onclose = () => appendLog("üî¥ WebSocket disconnected");
ws.onerror = (e) => appendLog("‚ö†Ô∏è WebSocket error: " + e);

ws.onmessage = (event) => {
    let data;
    try { data = JSON.parse(event.data); } catch { data = { raw: event.data }; }

    const ts = new Date().toLocaleTimeString();
    document.getElementById("last-update").innerText = ts;

    // Handle heartbeat messages
    if (data.type === "heartbeat") {
        const driverName = data.node_name || "system";
        const status = data.status || "OK";
        const isEstop = (status === "E-STOP" || status === "E_STOP");
        
        document.getElementById('heartbeat_indicator').innerText = `‚è± ${ts} - ${driverName}: ${status}`;
        
        // Update driver-specific status with color coding
        const displayStatus = isEstop ? "üõë E-STOP" : "‚úÖ OK";
        
        if (driverName.includes("p2")) {
            const el = document.getElementById('p2_status');
            el.innerText = displayStatus;
            el.style.color = isEstop ? "#ff3b3b" : "#16a34a";
        } else if (driverName.includes("p3")) {
            const el = document.getElementById('p3_status');
            el.innerText = displayStatus;
            el.style.color = isEstop ? "#ff3b3b" : "#16a34a";
        } else if (driverName.includes("p4")) {
            const el = document.getElementById('p4_status');
            el.innerText = displayStatus;
            el.style.color = isEstop ? "#ff3b3b" : "#16a34a";
        }

        // Update system state based on ANY driver reporting E-STOP
        if (isEstop) {
            updateEStopDisplay(true);
            document.getElementById("system-state").innerText = "E-STOP ACTIVE";
        } else {
            // Only clear E-STOP if this was an E-STOP clear message
            // Check if message explicitly says cleared
            const sysStateEl = document.getElementById("system-state");
            if (sysStateEl.innerText === "E-STOP ACTIVE" && status === "OK") {
                // Keep E-STOP active until we get confirmation all drivers cleared
                // This will be handled by the log message
            }
        }
    }

    // Handle log messages
    if (data.type === "log") {
        const level = data.level || "INFO";
        const message = data.message || JSON.stringify(data);
        const source = data.source_node || "system";
        
        // Check for E-STOP in log messages
        if (message.includes("E-STOP ACTIVATED") || message.includes("HARD E-STOP") || message.includes("E_STOP")) {
            updateEStopDisplay(true);
            document.getElementById("system-state").innerText = "E-STOP ACTIVE";
            
            // Set all drivers to E-STOP state visually
            ["p2_status", "p3_status", "p4_status"].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.innerText = "üõë E-STOP";
                    el.style.color = "#ff3b3b";
                }
            });
        } else if (message.includes("E-STOP cleared") || message.includes("CLEAR_ESTOP")) {
            updateEStopDisplay(false);
            document.getElementById("system-state").innerText = "OPERATIONAL";
            
            // Reset all drivers to OK state
            ["p2_status", "p3_status", "p4_status"].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.innerText = "‚úÖ OK";
                    el.style.color = "#16a34a";
                }
            });
        }
        
        appendLog(`[${level}] ${source}: ${message}`);
    }

    // Handle telemetry (if still being sent)
    if (data.type === "telemetry") {
        if (data.estop !== undefined) {
            updateEStopDisplay(data.estop);
            document.getElementById("system-state").innerText = data.estop ? "E-STOP ACTIVE" : "OPERATIONAL";
        }
    }

    // Handle watchdog alerts
    if (data.type === "watchdog") {
        document.getElementById("system-state").innerText = "OFFLINE";
        appendLog(`‚ö†Ô∏è WATCHDOG: ${data.message}`);
    }

    // Log raw data for debugging
    if (data.type !== "heartbeat") {  // Don't spam logs with heartbeats
        appendLog(JSON.stringify(data));
    }
};
</script>


</body>
</html>